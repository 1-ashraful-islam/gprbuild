SHELL=/bin/sh
INSTALL=@INSTALL@
INSTALL_PROGRAM=@INSTALL_PROGRAM@
INSTALL_DATA=@INSTALL_DATA@
HOST=@HOST@
GNAT_SOURCE_DIR=gnat_src
CP=cp -p
MKDIR=mkdir -p
BUILD=debug

prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
datadir=@datadir@
bindir=@bindir@
libdir=@libdir@
libexecdir=@libexecdir@
docdir=${datadir}/doc/@PACKAGE_TARNAME@

GNATMAKE=gnatmake
ifeq ($(strip $(filter-out %vms%,$(HOST))),)
GNATMAKE=${GNATMAKE} -XOS=vms
endif

.PHONY: all gprbuild gprconfig gprclean copy_gnat_src
all:
	gnatmake -Pgprbuild -XBUILD=${BUILD}

all gprconfig gprbuild gprclean: obj/gprbuild_dummies.o obj/link.o force

copy_gnat_src: force
	-@$(foreach f,$(shell cat gnat/MANIFEST.GPRBUILD), \
	    $(CP) $(GNAT_SOURCE_DIR)/$(f) gnat ;\
           )\
	  cd gnat && patch < prj-gnat-6.0.1.diff

gprbuild gprclean:
	gnatmake -Pgprbuild -XBUILD=${BUILD} $@

gprconfig:
	gnatmake -Pgprbuild -XBUILD=${BUILD} gprconfig-main

.PHONY: install clean distclean

install: all
	${MKDIR} ${bindir}
	${MKDIR} ${libexecdir}/gprbuild
	${MKDIR} ${datadir}/gpr
	${MKDIR} ${datadir}/gprconfig
	${INSTALL_PROGRAM} gprconfig ${bindir}
	${INSTALL_PROGRAM} gprbuild ${bindir}
	${INSTALL_PROGRAM} gprclean ${bindir}
	${INSTALL_PROGRAM} gprbind ${libexecdir}/gprbuild/
	${INSTALL_PROGRAM} gprlib ${libexecdir}/gprbuild/
	${INSTALL_PROGRAM} create_ada_runtime_project ${libexecdir}/gprbuild/
	${INSTALL_DATA} share/gprconfig/*.xml ${datadir}/gprconfig
	${INSTALL_DATA} share/gprconfig/gnat_runtime.mapping ${datadir}/gprconfig
	$(RM) -r ${datadir}/examples/gprbuild
	${MKDIR} ${datadir}/examples/gprbuild
	${CP} -r examples/* ${datadir}/examples/gprbuild

obj/gprbuild_dummies.o: src/gprbuild_dummies.c
	gcc -c -o $@ $<

obj/link.o: gnat/link.c
	gcc -c -o $@ $<

clean:
	gnat clean -q -r -Pgprbuild

distclean:
	gnat clean -q -r -Pgprbuild
	@${RM} config.log config.status src/gprconfig-sdefault.ads
	@${RM} Makefile
	@${RM} obj/*
	make -C doc clean
	make -C examples clean

.PHONY: doc install-doc tests examples force
doc:
	make -C doc

install-doc:
	$(MKDIR) ${docdir}/gprbuild/html
	${INSTALL_DATA} doc/*.html ${docdir}/gprbuild/html

tests: force
	cd tests; ./test.cmd
examples: force
	make -C examples
force:
