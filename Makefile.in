SHELL=/bin/sh
INSTALL=@INSTALL@
INSTALL_PROGRAM=@INSTALL_PROGRAM@
INSTALL_DATA=@INSTALL_DATA@
HOST=@HOST@

# Relative to the gnat/ subdirectory (or absolute path)
GNAT_SOURCE_DIR=../gnat_src

ifeq ($(OS),Windows_NT)
LN=cp -p
else
LN=ln -s -f
endif
CP=cp -p
MKDIR=mkdir -p
BUILD=debug

prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
datadir=@datadir@
bindir=@bindir@
libdir=@libdir@
libexecdir=@libexecdir@
docdir=${datadir}/doc/@PACKAGE_TARNAME@

# How do we want to use XML/Ada ?
LIBRARY_TYPE=static
export LIBRARY_TYPE

objdir=obj
ifeq ($(BUILD), debug)
objdir=obj-debug
endif
ifeq ($(BUILD), coverage)
objdir=obj-cov
endif
ifeq ($(BUILD), profiling)
objdir=obj-prof
endif

dummy:=$(shell $(MKDIR) $(objdir))

GNATMAKE=gnatmake -p -m
ifeq ($(strip $(filter-out %vms%,$(HOST))),)
GNATMAKE=${GNATMAKE} -XOS=vms
endif

.PHONY: all gprbuild gprconfig gprclean copy_gnat_src complete bootstrap
all:
	${GNATMAKE} -Pgprbuild -XBUILD=${BUILD}

all gprconfig gprbuild gprclean: $(objdir)/gprbuild_dummies.o $(objdir)/link.o force

copy_gnat_src: force
	-@cd gnat; $(foreach f,$(shell cat gnat/MANIFEST.GPRBUILD), \
	    $(LN) $(GNAT_SOURCE_DIR)/$(f) . ;\
           )\
	gnatmake -q xsnamest.adb; \
	./xsnamest; \
	$(CP) snames.ns snames.ads; \
	$(CP) snames.nb snames.adb

complete: copy_gnat_src all install

gprbuild gprclean:
	${GNATMAKE} -Pgprbuild -XBUILD=${BUILD} $@

gprconfig:
	${GNATMAKE} -Pgprbuild -XBUILD=${BUILD} gprconfig-main

bootstrap: gprconfig gprbuild
	echo
	echo "=== Bootstraping grpbuild"
	make install prefix=bootstrap/install
	-${MKDIR} bootstrap/${objdir}
	bootstrap/install/bin/gprbuild -Pgprbuild -XBUILD=${BUILD} \
	  -XBUILD_TOOL=gprbuild

.PHONY: install clean distclean bootstrap-clean

bootstrap-clean:
	bootstrap/install/bin/gprclean -Pgprbuild -XBUILD=${BUILD} \
	  -XBUILD_TOOL=gprbuild

install: install.data install.bin
	-${MKDIR} ${datadir}/gpr
	-${MKDIR} ${datadir}/gps/plug-ins/
	${INSTALL} doc/gprbuild_gps.xml ${datadir}/gps/plug-ins/
	$(RM) -r ${datadir}/examples/gprbuild
	-${MKDIR} ${datadir}/examples/gprbuild
	${CP} -r examples/* ${datadir}/examples/gprbuild
	${RM} -r ${datadir}/doc/gprbuild
	-${MKDIR} ${datadir}/doc/gprbuild
	for format in html txt pdf info; do \
	  if [ -d doc/$$format ] ; then \
	     ${MKDIR} ${datadir}/doc/gprbuild/$$format; \
	     ${CP} doc/$$format/* ${datadir}/doc/gprbuild/$$format; \
	     if [ $$format = html ] ; then \
	        ${CP} doc/*.png ${datadir}/doc/gprbuild/html; \
	     fi; \
	  fi; \
	done

install.data: force
	-${MKDIR} ${datadir}/gprconfig
	${CP} share/gprconfig/*.xml ${datadir}/gprconfig

install.bin: force
	-${MKDIR} ${bindir}
	${INSTALL_PROGRAM} gprconfig ${bindir}
	${INSTALL_PROGRAM} gprbuild ${bindir}
	${INSTALL_PROGRAM} gprclean ${bindir}
	-${MKDIR} ${libexecdir}/gprbuild
	${INSTALL_PROGRAM} gprbind ${libexecdir}/gprbuild/
	${INSTALL_PROGRAM} gprlib ${libexecdir}/gprbuild/

$(objdir)/gprbuild_dummies.o: src/gprbuild_dummies.c
	gcc -c -o $@ $<

$(objdir)/link.o: gnat/link.c
	gcc -c -o $@ $<

clean:
	gnat clean -q -r -Pgprbuild

distclean:
	gnat clean -q -r -Pgprbuild
	@${RM} config.log config.status src/gprconfig-sdefault.ads
	@${RM} Makefile
	@${RM} $(objdir)/*
	@${RM} -r bootstrap
	make -C doc clean
	make -C examples clean

.PHONY: doc install-doc tests examples force
doc:
	make -C doc

install-doc:
	-$(MKDIR) ${docdir}/html
	${CP} doc/*.html ${docdir}/html

tests: force
	cd internal/gprtests; ./run-test

examples: force
	make -C examples
force:
